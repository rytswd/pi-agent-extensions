#+title: Slow Mode
#+state: complete
#+FILETAGS: :extension:feature:

* Summary

A pi extension that intercepts ~write~ and ~edit~ tool calls, letting the user review proposed changes before they are applied. New files go to a tmp staging directory; edits produce a unified diff patch file — both are shown for review before committing.

* Motivation

When the LLM makes code changes, they are applied immediately. This is efficient but risky — a bad edit or an unwanted new file is already on disk before the user sees it. Slow mode adds a review gate so the user can approve, reject, or inspect changes before they land.

** Goals
- Intercept ~write~ tool calls: stage new file content in a tmp directory, show it, let user approve/reject.
- Intercept ~edit~ tool calls: stage old/new files in a tmp directory, open in external diff viewer by default (delta/vim/diff), let user approve/reject.
- Fallback to inline TUI diff if no external viewer available.
- On approve: proceed with the original tool execution.
- On reject: block the tool call with a reason (using ~ToolCallEventResult.block~).
- Toggle slow mode on/off via a ~/slow-mode~ command.
- Show status bar indicator when slow mode is active.

** Non-Goals
- Intercepting ~bash~ commands (too broad, user already has confirmation via pi's built-in mechanism).
- Providing an in-TUI editor for modifying the proposed changes.
- Persisting slow mode state across sessions.

* Proposal

** Interception Mechanism

Use the ~tool_call~ event, which fires before tool execution. The handler returns ~ToolCallEventResult~:
- ~{ block: true, reason: "..." }~ to reject and report back to the LLM.
- ~undefined~ (no return) to let the tool proceed normally.

** Write Tool (new files / overwrites)

1. On ~tool_call~ where ~toolName === "write"~:
   - Extract ~path~ and ~content~ from ~event.input~.
   - Write content to a staging file under ~/tmp/pi-slow-mode/~ mirroring the relative path.
   - Show a review UI (~ctx.ui.custom~) displaying the staged file path and content.
   - User presses Enter to approve or Esc to reject.
2. If approved: return ~undefined~ (tool proceeds normally).
3. If rejected: return ~{ block: true, reason: "User rejected the write" }~.
4. Clean up the staged file after decision.

** Edit Tool (modifications)

1. On ~tool_call~ where ~toolName === "edit"~:
   - Extract ~path~, ~oldText~, ~newText~ from ~event.input~.
   - Stage both old and new text as separate files (~<name>-<ts>.old~ / ~<name>-<ts>.new~) in the tmp directory.
   - Try to open in external diff viewer (delta → nvim → vim → diff) by default.
   - If external viewer available: user reviews changes, closes viewer, then gets Yes/No confirmation prompt.
   - If no external viewer: show inline TUI diff with vim-style navigation (j/k, u/d, gg/G, Ctrl+O to try external).
2. Same approve/reject flow as write.
3. Clean up both staged files after decision.

** Toggle Command

Register ~/slow-mode~ command:
- Toggles a boolean ~enabled~ flag.
- Updates status bar: ~"slow ■"~ when on, cleared when off.
- Notifies user of state change.

** UI Design

*** External Diff Viewer (Edit operations - default)
- Opens delta/vim/diff automatically when available
- User reviews changes in external tool
- After closing external viewer, shows simple confirmation:
  - "Apply changes to <file>?" with Yes/No options

*** Inline TUI Review (Fallback for edits, default for writes)
Review component (via ~ctx.ui.custom~):
- Top: separator line
- File path in accent colour
- Operation label: "NEW FILE" or "EDIT (diff)"
- Content/diff body (scrollable with vim-style navigation: j/k, u/d, gg/G)
- Ctrl+O to open in external viewer
- Bottom: key binding hints
- Bottom: separator line

Keep it simple — no tabs, no multi-select. One change at a time, inline with the tool call flow.

* Design Details

** Staging Directory
- ~/tmp/pi-slow-mode-<pid>/~ to avoid collisions between sessions.
- Created on first use, cleaned up lazily (OS handles ~/tmp~ cleanup).
- For writes: mirror the relative path structure (e.g., ~src/foo.ts~ → ~/tmp/pi-slow-mode-<pid>/src/foo.ts~).
- For edits: stage old/new as ~<filename>-<timestamp>.old~ / ~.new~ in the tmp directory.

** Diff Generation
- Uses the ~diff~ npm package (Myers algorithm) to generate proper unified diffs with context lines.
- Produces output similar to ~git diff~ and pi's own edit tool result rendering.
- Shows only changed sections with surrounding context (3 lines), not all old lines removed then all new lines added.

** Non-Interactive Mode
- If ~!ctx.hasUI~, slow mode is a no-op (all changes proceed immediately).
- The ~/slow-mode~ command is available only in interactive mode.

** Vim-Style Navigation
- Inline TUI diff supports vim-style keybindings for navigation:
  - ~j/k~ — scroll down/up one line
  - ~u/d~ — scroll up/down half page (15 lines)
  - ~gg~ — jump to top (double-tap g within 500ms)
  - ~G~ — jump to bottom
  - Arrow keys and PgUp/PgDn also supported for users who prefer those

** Dependencies
- ~diff~ npm package (v7+) for proper unified diff generation
- Located in extension directory with its own ~package.json~

** Test Plan
- Manual testing via ~/slow-mode~ toggle.
- Test with ~write~ of a new file — verify staging + inline review.
- Test with ~edit~ of an existing file:
  - Verify external diff viewer opens by default (delta/vim/diff)
  - Verify Yes/No confirmation after closing viewer
  - Verify fallback to inline diff if no external viewer available
  - Verify Ctrl+O from inline view opens external viewer
  - Verify vim-style navigation (j/k, u/d, gg/G) in inline view
- Test reject flow — verify tool is blocked and LLM gets the rejection message.
- Test with ~ctx.hasUI === false~ — verify pass-through.

* Drawbacks
- Adds friction to every write/edit when enabled — only useful when caution is needed.
- External diff viewer blocks the terminal session until closed — may be disruptive for rapid iteration.
- Users without delta/vim may get a suboptimal inline diff experience (though vim-style navigation helps).

* Alternatives
- Could intercept at ~tool_result~ level and revert — but that's more complex and leaves a window where bad changes exist on disk.
- Could use ~ctx.ui.confirm~ instead of ~ctx.ui.custom~ — simpler but less informative (no diff preview).
- Could try to import pi's internal ~generateDiffString~ — but it's not in the public API and import paths break in extension context.

* History
- 2026-02-01: Initial specification drafted.
- 2026-02-01: Implementation complete — slow-mode.ts created.
- 2026-02-02: Command renamed from ~/slowmode~ to ~/slow-mode~.
- 2026-02-02: Added Ctrl+O to open external diff viewer.
- 2026-02-02: Added vim-style navigation (j/k, u/d, gg/G) to inline diff view.
- 2026-02-02: Changed default behavior for edits to open external diff viewer (delta/vim/diff) first, with inline TUI as fallback.

* References
- ~ToolCallEventResult.block~ — upstream mechanism for rejecting tool calls.
- ~ctx.ui.custom<T>~ — TUI component API for interactive review.
- ~direnv.ts~, ~questionnaire.ts~ — existing extension patterns.
