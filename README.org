#+TITLE: pi-agent-extensions
#+AUTHOR: rytswd
#+OPTIONS: toc:3 num:nil ^:nil

#+html:<div align="center">
#+html:<p>A collection of extensions for <a href="https://github.com/mariozechner/pi">pi</a> coding agent</p>
#+html:<p>
#+html:<img src="https://img.shields.io/badge/pi-extensions-blue?style=flat-square" alt="pi extensions">
#+html:<a href="https://github.com/rytswd/pi-agent-extensions"><img src="https://img.shields.io/badge/Source-grey?style=flat-square&logo=github" alt="GitHub Source"></a>
#+html:<img src="https://img.shields.io/badge/License-MIT-blue?style=flat-square" alt="MIT License">
#+html:</p>
#+html:</div>

-----

** üåÑ Overview

*pi-agent-extensions* is a collection of [[https://github.com/mariozechner/pi][pi]] coding agent extensions that enhance the development experience. Each extension is a standalone TypeScript file that plugs into pi's extension system.

These extensions live in =~/.pi/agent/extensions/= for global auto-discovery ‚Äî just drop them in and they're loaded on every pi session.

** ‚ú® Extensions

*** slow-mode

Intercepts ~write~ and ~edit~ tool calls, letting you review proposed changes before they are applied. Write operations show an inline preview; edit operations open in an external diff viewer by default (delta/vim/diff), with inline TUI as fallback.

*Features:*
- *External diff viewer by default* for edits ‚Äî opens delta/vim/diff automatically, shows Yes/No confirmation after review
- *Proper unified diff* using Myers algorithm (via ~diff~ npm package) ‚Äî shows only changed sections with context, not all old lines removed then all new added
- *Vim-style navigation* in inline TUI ‚Äî j/k, u/d, gg/G for scrolling
- *Ctrl+O* from inline view opens external diff viewer
- Toggle command: ~/slow-mode~
- Status bar indicator: ~slow ‚ñ†~ (active) or cleared (inactive)
- No-op in non-interactive mode (headless sessions bypass the review)

*Key bindings (inline TUI):*
- ~Enter~ - approve changes
- ~Esc~ - reject changes
- ~Ctrl+O~ - open in external diff viewer
- ~j/‚Üì~ - scroll down one line
- ~k/‚Üë~ - scroll up one line
- ~d/PgDn~ - scroll down half page (15 lines)
- ~u/PgUp~ - scroll up half page (15 lines)
- ~gg~ - jump to top (double-tap g)
- ~G~ - jump to bottom

*Requirements:*
- ~diff~ npm package (installed in extension directory)
- Optional: ~delta~, ~nvim~, or ~vim~ for better external diff viewing

*** questionnaire

A tool that the LLM can invoke to ask you single or multiple-choice questions. Provides an interactive TUI for collecting structured input from the user during agent execution.

*Features:*
- *Single question mode* ‚Äî simple option list with keyboard navigation
- *Multi-question mode* ‚Äî tab bar for navigating between questions, with completion indicators (‚ñ†/‚ñ°)
- *Free-text input* ‚Äî "Type something..." option allows custom responses
- *Submit review screen* ‚Äî shows all answers before final confirmation
- *Autocomplete support* ‚Äî integrates with pi's TUI autocomplete system
- Custom ~renderCall~ and ~renderResult~ for clean tool display in chat history

*Key bindings (single question):*
- ~‚Üë‚Üì~ - navigate options
- ~Enter~ - select option
- ~Esc~ - cancel

*Key bindings (multi-question):*
- ~Tab/‚Üê‚Üí~ - navigate between question tabs
- ~‚Üë‚Üì~ - navigate options within current question
- ~Enter~ - confirm answer (advances to next question or submit screen)
- ~Esc~ - cancel questionnaire

*Usage:*
The LLM calls this tool when it needs structured input. For example:
- Asking which file to edit when multiple matches exist
- Confirming destructive operations with Yes/No
- Collecting configuration preferences before code generation
- Multi-step wizards (e.g., "Choose framework" ‚Üí "Choose features" ‚Üí "Confirm")

#+begin_quote
üí° The questionnaire extension is inspired by patterns from [[https://github.com/Mic92][Mic92]]'s pi extensions. Thanks Mic92!
#+end_quote

*** direnv

Automatically loads [[https://direnv.net/][direnv]] environment variables into pi sessions. This mimics how the direnv shell hook works ‚Äî it runs after every bash command to pick up any =.envrc= changes from =cd=, =git checkout=, etc.

*Features:*
- Loads environment on session start
- Re-evaluates after every bash command (handles =cd=, =git checkout=, =direnv allow=, etc.)
- Serialised execution ‚Äî only one direnv process runs at a time
- 10s timeout so fast completions are handled inline; longer ones finish in the background
- Status bar indicator: =direnv ‚Ä¶= (running), =direnv ‚úì= (loaded), =direnv ‚úó= (error)

*Requirements:*
- =direnv= installed and in PATH
- =.envrc= must be allowed (run =direnv allow= in your shell first)

#+begin_quote
üí° The direnv extension is based on the original implementation by [[https://github.com/Mic92][Mic92]] from [[https://github.com/Mic92/dotfiles/blob/main/home/.pi/agent/extensions/direnv.ts][Mic92/dotfiles]]. Thanks Mic92!
#+end_quote

** üöÄ Quick Start

*** 1. Clone to pi Extensions Directory

#+begin_src bash
git clone git@github.com:rytswd/pi-agent-extensions.git ~/.pi/agent/extensions
#+end_src

If you already have =~/.pi/agent/extensions/=, you can cherry-pick individual files instead.

*** 2. Use pi as Normal

Extensions are auto-discovered. Start pi in any project directory and they'll be loaded automatically.

#+begin_src bash
pi
#+end_src

You'll see the direnv status indicator in the status bar once it kicks in.

** üìÅ Structure

#+begin_example
~/.pi/agent/extensions/
‚îú‚îÄ‚îÄ direnv.ts           # Direnv integration extension
‚îú‚îÄ‚îÄ questionnaire.ts    # Multi-question tool for LLM-driven user input
‚îú‚îÄ‚îÄ slow-mode.ts        # Review gate for write/edit tool calls
‚îú‚îÄ‚îÄ package.json        # npm dependencies for extensions (diff package)
‚îú‚îÄ‚îÄ node_modules/       # npm packages (diff for slow-mode)
‚îú‚îÄ‚îÄ AGENTS.md           # Agent context for AI assistants
‚îú‚îÄ‚îÄ air/                # Air documentation (development planning)
‚îÇ   ‚îú‚îÄ‚îÄ context/        # Project context files
‚îÇ   ‚îî‚îÄ‚îÄ ...
‚îî‚îÄ‚îÄ README.org          # This file
#+end_example

** üîß Adding New Extensions

To add a new extension, create a =.ts= file in the root directory. pi auto-discovers any =*.ts= file here.

A minimal extension looks like:

#+begin_src typescript
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  pi.on("session_start", async (_event, ctx) => {
    ctx.ui.notify("My extension loaded!", "info");
  });
}
#+end_src

For multi-file extensions, create a subdirectory with an =index.ts= entry point.

See the [[https://github.com/mariozechner/pi][pi documentation]] for the full extension API.

** üôè Acknowledgements

- [[https://github.com/Mic92][Mic92]] ‚Äî Original direnv extension implementation ([[https://github.com/Mic92/dotfiles/blob/main/home/.pi/agent/extensions/direnv.ts][source]])
- [[https://github.com/mariozechner][Mario Zechner]] ‚Äî pi coding agent

** üìÑ License

MIT
