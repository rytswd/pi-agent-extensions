#+TITLE: pi-agent-extensions
#+AUTHOR: rytswd
#+OPTIONS: toc:3 num:nil ^:nil

#+html:<div align="center">
#+html:<p>A collection of extensions for <a href="https://github.com/mariozechner/pi">pi</a> coding agent</p>
#+html:<p>
#+html:<img src="https://img.shields.io/badge/pi-extensions-blue?style=flat-square" alt="pi extensions">
#+html:<a href="https://github.com/rytswd/pi-agent-extensions"><img src="https://img.shields.io/badge/Source-grey?style=flat-square&logo=github" alt="GitHub Source"></a>
#+html:<img src="https://img.shields.io/badge/License-MIT-blue?style=flat-square" alt="MIT License">
#+html:</p>
#+html:</div>

-----

** ğŸŒ„ Overview

*pi-agent-extensions* is a collection of [[https://github.com/mariozechner/pi][pi]] coding agent extensions that enhance the development experience. Each extension is a standalone TypeScript file that plugs into pi's extension system.

These extensions live in =~/.pi/agent/extensions/= for global auto-discovery â€” just drop them in and they're loaded on every pi session.

** âœ¨ Extensions

*** slow-mode â€” Review Changes Before Applying

Intercepts =write= and =edit= tool calls, letting you review and approve/reject changes before they hit disk.

#+html:<details>
#+html:<summary><b>What it looks like</b></summary>
#+html:<br>

*For edits:* Opens delta/vim diff viewer by default

#+begin_example
# Delta opens in your terminal showing side-by-side diff
# After you close delta, you get a confirmation prompt:

Apply changes to air/slow-mode.org?
  > Yes
    No
#+end_example

*For writes (or if no external viewer):* Shows inline TUI diff

#+begin_example
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
 EDIT (diff)
 slow-mode.ts

 @@ -28,7 +28,9 @@
  export default function slowMode(pi: ExtensionAPI) {
 +  // State: whether slow mode is currently enabled
    let enabled = false;
 +
 +  // Staging directory for review
    const tmpDir = `/tmp/pi-slow-mode-${process.pid}`;

 (lines 1â€“30 of 150 â€” j/k u/d gg/G scroll)

 Enter approve â€¢ Esc reject â€¢ Ctrl+O external â€¢ j/k u/d gg/G scroll
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#+end_example

#+html:</details>

#+html:<details>
#+html:<summary><b>Features & Usage</b></summary>
#+html:<br>

*Features:*
- *External diff viewer by default* for edits â€” opens delta/vim/diff, shows confirmation after review
- *Proper unified diff* using Myers algorithm â€” shows only changed sections with context
- *Vim-style navigation* in inline TUI â€” =j/k=, =u/d=, =gg/G= for scrolling
- =Ctrl+O= from inline view opens external diff viewer
- Toggle command: =/slow-mode=
- Status bar: =slow â– = (active) or cleared (inactive)

*Key bindings (inline TUI):*
| Key           | Action                       |
|---------------+------------------------------|
| =Enter=       | Approve changes              |
| =Esc=         | Reject changes               |
| =Ctrl+O=      | Open in external diff viewer |
| =j= / =â†“=     | Scroll down one line         |
| =k= / =â†‘=     | Scroll up one line           |
| =d= / =PgDn=  | Scroll down half page        |
| =u= / =PgUp=  | Scroll up half page          |
| =gg=          | Jump to top (double-tap g)   |
| =G=           | Jump to bottom               |

*Requirements:*
- =diff= package (automatically installed via =bun install= â€” see Quick Start)
- Optional: =delta=, =nvim=, or =vim= for external diff viewing

*Note:* The =diff= package provides proper unified diff generation (Myers algorithm). Without it, this extension will fail to load.

#+html:</details>

*** questionnaire â€” Interactive Multi-Question Tool

A tool the LLM can call to ask you single or multiple-choice questions with tab-based navigation.

#+html:<details>
#+html:<summary><b>What it looks like</b></summary>
#+html:<br>

*Multi-question flow:*

#+begin_example
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â† â–¡ Framework  â–¡ TypeScript  â–¡ Styling  âœ“ Submit â†’

Which framework would you like to use?

> 1. React
     Component-based library
  2. Vue
     Progressive framework
  3. Svelte
     Compiled framework
  4. Type something.

Tab/â†â†’ navigate â€¢ â†‘â†“ select â€¢ Enter confirm â€¢ Esc cancel
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#+end_example

After selecting "React" and pressing Enter:

#+begin_example
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â† â–  Framework  â–¡ TypeScript  â–¡ Styling  âœ“ Submit â†’

Do you want to use TypeScript?

> 1. Yes
  2. No

Tab/â†â†’ navigate â€¢ â†‘â†“ select â€¢ Enter confirm â€¢ Esc cancel
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#+end_example

Final submit screen shows all answers:

#+begin_example
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
â† â–  Framework  â–  TypeScript  â–  Styling  âœ“ Submit â†’

Ready to submit

Framework: 1. React
TypeScript: 1. Yes
Styling: 1. Tailwind CSS

Press Enter to submit

Tab/â†â†’ navigate â€¢ â†‘â†“ select â€¢ Enter confirm â€¢ Esc cancel
â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€
#+end_example

#+html:</details>

#+html:<details>
#+html:<summary><b>Features & Usage</b></summary>
#+html:<br>

*Features:*
- *Single question mode* â€” simple option list
- *Multi-question mode* â€” tab bar with completion indicators (â– /â–¡)
- *Free-text input* â€” "Type something..." option with inline editor
- *Submit review screen* â€” shows all answers before confirmation
- Custom rendering in chat history

*Key bindings (single question):*
| Key     | Action          |
|---------+-----------------|
| =â†‘â†“=    | Navigate        |
| =Enter= | Select          |
| =Esc=   | Cancel          |

*Key bindings (multi-question):*
| Key              | Action                 |
|------------------+------------------------|
| =Tab= / =â†â†’=     | Navigate between tabs  |
| =â†‘â†“=             | Navigate options       |
| =Enter=          | Confirm (advances tab) |
| =Esc=            | Cancel                 |

*When the LLM uses it:*
- Configuration wizards (e.g., project setup with framework/features/deploy choices)
- Disambiguation ("Which =config.ts= did you mean?")
- Confirmations with context ("Delete these 15 files? Yes/No")
- Multi-step workflows

#+html:</details>

*** direnv â€” Auto-Load Environment Variables

Automatically loads [[https://direnv.net/][direnv]] environment variables into pi sessions, running after every bash command to pick up =.envrc= changes.

#+html:<details>
#+html:<summary><b>What it looks like</b></summary>
#+html:<br>

*Status bar indicator:*

#+begin_example
# While loading:
direnv â€¦

# Successfully loaded:
direnv âœ“

# Error (e.g., .envrc not allowed):
direnv âœ—
#+end_example

*When it runs:*
- On session start
- After every bash command (picks up =cd=, =git checkout=, =direnv allow=, etc.)

#+html:</details>

#+html:<details>
#+html:<summary><b>Features & Usage</b></summary>
#+html:<br>

*Features:*
- Loads environment on session start
- Re-evaluates after every bash command
- Serialized execution â€” only one direnv process at a time
- 10s timeout for fast completions (longer ones finish in background)
- Status bar indicator: =direnv â€¦= (running), =direnv âœ“= (loaded), =direnv âœ—= (error)

*Requirements:*
- =direnv= installed and in PATH
- =.envrc= must be allowed (run =direnv allow= in your shell first)

#+begin_quote
ğŸ’¡ Based on the original implementation by [[https://github.com/Mic92][Mic92]] from [[https://github.com/Mic92/dotfiles/blob/main/home/.pi/agent/extensions/direnv.ts][Mic92/dotfiles]]. Thanks Mic92!
#+end_quote

#+html:</details>

** ğŸ“¦ Installation

Choose one of the following methods:

*** Method 1: Install via pi Package Manager (Recommended)

#+begin_src bash
pi install git:github/rytswd/pi-agent-extensions
#+end_src

This command:
1. Clones the repository to =~/.pi/agent/packages/=
2. Runs =npm install= to install dependencies
3. Adds the package path to =~/.pi/agent/settings.json= (="packages"= stanza)
4. Makes all extensions available to pi automatically

*** Method 2: Manual Installation via Git Clone + Package Configuration

1. Clone the repository to any directory:

#+begin_src bash
git clone https://github.com/rytswd/pi-agent-extensions.git ~/path/to/pi-agent-extensions
#+end_src

2. Add the package to pi's configuration by editing =~/.pi/agent/settings.json=:

#+begin_src json
{
  "packages": [
    "/absolute/path/to/pi-agent-extensions"
  ]
}
#+end_src

*** Method 3: Copy Individual Extensions

For selective installation, copy specific extension directories to =~/.pi/agent/extensions/=:

#+begin_src bash
# Copy only the extensions you want
cp -r /path/to/pi-agent-extensions/slow-mode ~/.pi/agent/extensions/
cp -r /path/to/pi-agent-extensions/direnv ~/.pi/agent/extensions/
cp -r /path/to/pi-agent-extensions/questionnaire ~/.pi/agent/extensions/
#+end_src

Or clone directly to the extensions directory:

#+begin_src bash
git clone https://github.com/rytswd/pi-agent-extensions.git ~/.pi/agent/extensions/pi-agent-extensions
#+end_src

*Note:* If an extension has dependencies (e.g., =slow-mode= requires the =diff= package), you'll need to install them:

#+begin_src bash
cd ~/.pi/agent/extensions/slow-mode
bun install
#+end_src

Extensions are auto-discovered from =~/.pi/agent/extensions/= â€” pi loads all =*.ts= files and =index.ts= files in subdirectories.

** âš™ï¸ Configuration

Once installed, pi can use *all* of the extensions listed in this package's =package.json=:
- =direnv=
- =questionnaire=
- =slow-mode=
- =@marckrenn/pi-sub-core= (subscription management)
- =@marckrenn/pi-sub-bar= (subscription status bar)

*By default, all extensions are enabled.*

To enable or disable specific extensions:

#+begin_src bash
pi config
#+end_src

This opens pi's configuration interface where you can toggle individual extensions on/off.

** ğŸš€ Quick Start

After installation, start using pi normally:

#+begin_src bash
pi
#+end_src

*** Try the Extensions

- *slow-mode:* Type =/slow-mode= to toggle the review gate
- *questionnaire:* The LLM will call it automatically when needed
- *direnv:* Watch the status bar â€” it loads automatically if you have =.envrc= files
- *subscription tools:* Use =sub_get_usage= and =sub_get_all_usage= tools, see status in the bar

** ğŸ“ Structure

#+begin_example
~/.pi/agent/extensions/
â”œâ”€â”€ direnv/             # Direnv integration
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ questionnaire/      # Multi-question tool
â”‚   â””â”€â”€ index.ts
â”œâ”€â”€ slow-mode/          # Review gate for write/edit
â”‚   â”œâ”€â”€ index.ts
â”‚   â”œâ”€â”€ package.json    # Dependencies (diff package)
â”‚   â”œâ”€â”€ package-lock.json
â”‚   â”œâ”€â”€ bun.lock
â”‚   â””â”€â”€ node_modules/   # npm packages (gitignored)
â”œâ”€â”€ .gitignore          # Ignores node_modules, logs
â”œâ”€â”€ AGENTS.md           # Agent context for AI assistants
â”œâ”€â”€ air/                # Air documentation (development planning)
â”‚   â”œâ”€â”€ context/        # Project context files
â”‚   â””â”€â”€ ...
â””â”€â”€ README.org          # This file
#+end_example

** ğŸ”§ Adding New Extensions

To add a new extension, create a directory with an =index.ts= file. pi auto-discovers =*.ts= files and =index.ts= files in subdirectories.

A minimal extension looks like:

#+begin_src typescript
import type { ExtensionAPI } from "@mariozechner/pi-coding-agent";

export default function (pi: ExtensionAPI) {
  pi.on("session_start", async (_event, ctx) => {
    ctx.ui.notify("My extension loaded!", "info");
  });
}
#+end_src

*Recommended structure:*

#+begin_example
my-extension/
â”œâ”€â”€ index.ts           # Extension entrypoint
â”œâ”€â”€ package.json       # Optional: if you need dependencies
â””â”€â”€ node_modules/      # Optional: npm packages (gitignored)
#+end_example

See the [[https://github.com/mariozechner/pi][pi documentation]] for the full extension API.

** ğŸ™ Acknowledgements

- [[https://github.com/Mic92][Mic92]] â€” Original direnv implementation ([[https://github.com/Mic92/dotfiles/blob/main/home/.pi/agent/extensions/direnv.ts][source]])
- [[https://github.com/mariozechner][Mario Zechner]] â€” pi coding agent

** ğŸ“„ License

MIT
